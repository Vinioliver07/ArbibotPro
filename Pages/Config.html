import React, { useState, useEffect } from "react";
import { MonitoringConfig } from "@/entities/MonitoringConfig";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Badge } from "@/components/ui/badge";
import { 
  Settings, 
  Plus, 
  Trash2, 
  Save,
  AlertTriangle,
  CheckCircle
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

export default function Config() {
  const [configs, setConfigs] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [newConfig, setNewConfig] = useState({
    token_symbol: '',
    token_address: '',
    min_spread: 0.5,
    min_profit: 50,
    max_loan_amount: 100000,
    enabled_dexs: ['Uniswap', 'Sushiswap', 'PancakeSwap'],
    is_active: true
  });

  const availableDexs = [
    'Uniswap', 'Sushiswap', 'PancakeSwap', 'Curve', 'Balancer', 
    '1inch', 'dYdX', 'Compound', 'Aave', 'Bancor'
  ];

  useEffect(() => {
    loadConfigs();
  }, []);

  const loadConfigs = async () => {
    setIsLoading(true);
    try {
      const data = await MonitoringConfig.list("-created_date");
      setConfigs(data);
    } catch (error) {
      console.error("Error loading configs:", error);
    }
    setIsLoading(false);
  };

  const saveConfig = async () => {
    setIsSaving(true);
    try {
      await MonitoringConfig.create(newConfig);
      setNewConfig({
        token_symbol: '',
        token_address: '',
        min_spread: 0.5,
        min_profit: 50,
        max_loan_amount: 100000,
        enabled_dexs: ['Uniswap', 'Sushiswap', 'PancakeSwap'],
        is_active: true
      });
      await loadConfigs();
    } catch (error) {
      console.error("Error saving config:", error);
    }
    setIsSaving(false);
  };

  const toggleDex = (dex) => {
    setNewConfig(prev => ({
      ...prev,
      enabled_dexs: prev.enabled_dexs.includes(dex)
        ? prev.enabled_dexs.filter(d => d !== dex)
        : [...prev.enabled_dexs, dex]
    }));
  };

  const updateConfigStatus = async (configId, isActive) => {
    try {
      await MonitoringConfig.update(configId, { is_active: isActive });
      await loadConfigs();
    } catch (error) {
      console.error("Error updating config:", error);
    }
  };

  const deleteConfig = async (configId) => {
    try {
      await MonitoringConfig.delete(configId);
      await loadConfigs();
    } catch (error) {
      console.error("Error deleting config:", error);
    }
  };

  return (
    <div className="min-h-screen p-4 md:p-8" style={{background: 'var(--primary-bg)'}}>
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <motion.div 
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="flex items-center gap-4 mb-8"
        >
          <div className="w-12 h-12 rounded-xl flex items-center justify-center"
               style={{background: 'var(--electric-blue)'}}>
            <Settings className="w-6 h-6 text-white" />
          </div>
          <div>
            <h1 className="text-3xl font-bold" style={{color: 'var(--text-primary)'}}>
              Configurações
            </h1>
            <p className="text-lg" style={{color: 'var(--text-secondary)'}}>
              Configure tokens e parâmetros de monitoramento
            </p>
          </div>
        </motion.div>

        <div className="grid lg:grid-cols-2 gap-8">
          {/* Add New Configuration */}
          <motion.div
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
          >
            <Card className="border"
                  style={{
                    background: 'var(--secondary-bg)',
                    borderColor: 'var(--border-color)'
                  }}>
              <CardHeader>
                <CardTitle className="flex items-center gap-2" style={{color: 'var(--text-primary)'}}>
                  <Plus className="w-5 h-5" />
                  Adicionar Token
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label style={{color: 'var(--text-secondary)'}}>Símbolo do Token</Label>
                    <Input
                      placeholder="ETH, BTC, USDC..."
                      value={newConfig.token_symbol}
                      onChange={(e) => setNewConfig({...newConfig, token_symbol: e.target.value.toUpperCase()})}
                      className="mt-1"
                      style={{
                        background: 'var(--accent-bg)',
                        borderColor: 'var(--border-color)',
                        color: 'var(--text-primary)'
                      }}
                    />
                  </div>
                  <div>
                    <Label style={{color: 'var(--text-secondary)'}}>Endereço do Contrato</Label>
                    <Input
                      placeholder="0x..."
                      value={newConfig.token_address}
                      onChange={(e) => setNewConfig({...newConfig, token_address: e.target.value})}
                      className="mt-1"
                      style={{
                        background: 'var(--accent-bg)',
                        borderColor: 'var(--border-color)',
                        color: 'var(--text-primary)'
                      }}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <div>
                    <Label style={{color: 'var(--text-secondary)'}}>Spread Mínimo (%)</Label>
                    <Input
                      type="number"
                      step="0.1"
                      value={newConfig.min_spread}
                      onChange={(e) => setNewConfig({...newConfig, min_spread: parseFloat(e.target.value)})}
                      className="mt-1"
                      style={{
                        background: 'var(--accent-bg)',
                        borderColor: 'var(--border-color)',
                        color: 'var(--text-primary)'
                      }}
                    />
                  </div>
                  <div>
                    <Label style={{color: 'var(--text-secondary)'}}>Lucro Mínimo ($)</Label>
                    <Input
                      type="number"
                      value={newConfig.min_profit}
                      onChange={(e) => setNewConfig({...newConfig, min_profit: parseInt(e.target.value)})}
                      className="mt-1"
                      style={{
                        background: 'var(--accent-bg)',
                        borderColor: 'var(--border-color)',
                        color: 'var(--text-primary)'
                      }}
                    />
                  </div>
                  <div>
                    <Label style={{color: 'var(--text-secondary)'}}>Max Flash Loan ($)</Label>
                    <Input
                      type="number"
                      value={newConfig.max_loan_amount}
                      onChange={(e) => setNewConfig({...newConfig, max_loan_amount: parseInt(e.target.value)})}
                      className="mt-1"
                      style={{
                        background: 'var(--accent-bg)',
                        borderColor: 'var(--border-color)',
                        color: 'var(--text-primary)'
                      }}
                    />
                  </div>
                </div>

                <div>
                  <Label className="mb-3 block" style={{color: 'var(--text-secondary)'}}>
                    DEXs Habilitadas
                  </Label>
                  <div className="grid grid-cols-2 gap-2">
                    {availableDexs.map(dex => (
                      <div key={dex} 
                           className={`p-3 rounded-lg border cursor-pointer transition-all duration-200 ${
                             newConfig.enabled_dexs.includes(dex) 
                               ? 'border-2' 
                               : 'border'
                           }`}
                           style={{
                             background: newConfig.enabled_dexs.includes(dex) 
                               ? 'var(--electric-blue)20' 
                               : 'var(--accent-bg)',
                             borderColor: newConfig.enabled_dexs.includes(dex) 
                               ? 'var(--electric-blue)' 
                               : 'var(--border-color)'
                           }}
                           onClick={() => toggleDex(dex)}>
                        <div className="flex items-center justify-between">
                          <span className="font-medium" style={{color: 'var(--text-primary)'}}>
                            {dex}
                          </span>
                          {newConfig.enabled_dexs.includes(dex) && (
                            <CheckCircle className="w-4 h-4" style={{color: 'var(--electric-blue)'}} />
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <Button
                  onClick={saveConfig}
                  disabled={isSaving || !newConfig.token_symbol}
                  className="w-full"
                  style={{
                    background: 'linear-gradient(135deg, var(--electric-blue), var(--profit-green))',
                    color: '#ffffff'
                  }}
                >
                  <Save className="w-4 h-4 mr-2" />
                  {isSaving ? 'Salvando...' : 'Salvar Configuração'}
                </Button>
              </CardContent>
            </Card>
          </motion.div>

          {/* Existing Configurations */}
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            className="space-y-4"
          >
            <h2 className="text-xl font-bold mb-4" style={{color: 'var(--text-primary)'}}>
              Tokens Configurados ({configs.length})
            </h2>

            <AnimatePresence>
              {isLoading ? (
                <div className="space-y-4">
                  {Array(3).fill(0).map((_, i) => (
                    <motion.div
                      key={i}
                      className="h-32 rounded-lg animate-pulse"
                      style={{background: 'var(--secondary-bg)'}}
                    />
                  ))}
                </div>
              ) : configs.length === 0 ? (
                <motion.div
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  className="text-center py-12"
                >
                  <AlertTriangle className="w-12 h-12 mx-auto mb-4" style={{color: 'var(--text-secondary)'}} />
                  <h3 className="text-lg font-medium mb-2" style={{color: 'var(--text-primary)'}}>
                    Nenhum token configurado
                  </h3>
                  <p style={{color: 'var(--text-secondary)'}}>
                    Adicione um token para começar o monitoramento
                  </p>
                </motion.div>
              ) : (
                configs.map((config, index) => (
                  <motion.div
                    key={config.id}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -20 }}
                    transition={{ delay: index * 0.1 }}
                  >
                    <Card className="border"
                          style={{
                            background: 'var(--secondary-bg)',
                            borderColor: 'var(--border-color)'
                          }}>
                      <CardHeader>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-lg flex items-center justify-center font-bold"
                                 style={{
                                   background: config.is_active ? 'var(--profit-green)20' : 'var(--text-secondary)20',
                                   color: config.is_active ? 'var(--profit-green)' : 'var(--text-secondary)'
                                 }}>
                              {config.token_symbol?.substring(0, 2)}
                            </div>
                            <div>
                              <h3 className="font-bold" style={{color: 'var(--text-primary)'}}>
                                {config.token_symbol}
                              </h3>
                              <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                {config.token_address?.substring(0, 10)}...
                              </p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <Switch
                              checked={config.is_active}
                              onCheckedChange={(checked) => updateConfigStatus(config.id, checked)}
                            />
                            <Button
                              variant="ghost"
                              size="icon"
                              onClick={() => deleteConfig(config.id)}
                              className="text-red-400 hover:text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </Button>
                          </div>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="grid grid-cols-3 gap-4 mb-4">
                          <div>
                            <p className="text-xs" style={{color: 'var(--text-secondary)'}}>Spread Min</p>
                            <p className="font-medium" style={{color: 'var(--text-primary)'}}>
                              {config.min_spread}%
                            </p>
                          </div>
                          <div>
                            <p className="text-xs" style={{color: 'var(--text-secondary)'}}>Lucro Min</p>
                            <p className="font-medium" style={{color: 'var(--text-primary)'}}>
                              ${config.min_profit}
                            </p>
                          </div>
                          <div>
                            <p className="text-xs" style={{color: 'var(--text-secondary)'}}>Max Loan</p>
                            <p className="font-medium" style={{color: 'var(--text-primary)'}}>
                              ${config.max_loan_amount?.toLocaleString()}
                            </p>
                          </div>
                        </div>
                        <div className="flex flex-wrap gap-1">
                          {config.enabled_dexs?.map(dex => (
                            <Badge 
                              key={dex} 
                              variant="secondary"
                              className="text-xs"
                              style={{
                                background: 'var(--electric-blue)20',
                                color: 'var(--electric-blue)',
                                border: 'none'
                              }}
                            >
                              {dex}
                            </Badge>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  </motion.div>
                ))
              )}
            </AnimatePresence>
          </motion.div>
        </div>
      </div>
    </div>
  );
}